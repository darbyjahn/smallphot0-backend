<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gallery</title>
<link rel="stylesheet" href="/styles.css">
</head>
<body>

<button onclick="location.href='/'">â¬… Back to All Galleries</button>
<button id="deleteBtn">Delete My Gallery</button>

<h1 id="title"></h1>

<div class="upload">
  <input type="file" id="files" multiple>
  <button onclick="upload()">Upload</button>
</div>

<div class="gallery" id="gallery"></div>

<div id="lightbox" onclick="closeLB()">
  <img id="lb-img">
</div>

<script>
const API_URL = "https://smallphot0-api.onrender.com";
let username = location.pathname.split("/")[2];

document.getElementById("deleteBtn").onclick = async () => {
  if (!confirm("Delete your gallery?")) return;
  try {
    const res = await fetch(`${API_URL}/api/delete/${username}`, { method: "DELETE" });
    const data = await res.json();
    if (data.success) location.href = '/';
    else alert(data.error || "Failed to delete");
  } catch (err) { console.error(err); alert("Server error"); }
};

function upload() {
  const files = document.getElementById("files").files;
  if (!files.length) return;
  const fd = new FormData();
  for (let f of files) fd.append("files", f);

  fetch(`${API_URL}/api/upload/${username}`, { method: "POST", body: fd })
    .then(res => res.json())
    .then(data => data.success ? location.reload() : alert(data.error || "Upload failed"))
    .catch(err => { console.error(err); alert("Server error"); });
}

/* LOAD GALLERY ITEMS */
fetch("gallery.json")
  .then(r => r.json())
  .then(g => {
    document.body.style.background = g.bg_color;
    document.body.style.color = g.text_color;
    document.getElementById("title").textContent = g.title;

    g.items.sort((a,b)=>a.batch-b.batch||a.seq-b.seq)
      .forEach(i => {
        const el = document.createElement(i.type==="video"?"video":"img");
        el.src = "media/" + i.stored;
        if (i.type==="video"){ el.controls=true; el.playsInline=true; }
        el.onclick = () => openLB(el.src);
        document.getElementById("gallery").appendChild(el);
      });
  });

function openLB(src){ document.getElementById("lb-img").src=src; document.getElementById("lightbox").style.display="flex"; }
function closeLB(){ document.getElementById("lightbox").style.display="none"; }
</script>
</body>
</html>
