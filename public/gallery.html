<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Gallery</title>
<link rel="stylesheet" href="/styles.css"/>

<style>
body{margin:0;font-family:Arial,Helvetica,sans-serif}

/* HEADER */
.header{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  align-items:center;
  padding:10px;
}
.header button{
  font-size:13px;
  cursor:pointer;
  transition:0.2s all;
  padding:6px 12px;
  border:none;
  border-radius:4px;
  box-shadow:0 4px #999;
  background:#eee;
}
.header button:active{
  transform:translateY(2px);
  box-shadow:0 2px #666;
}
.header button:hover{
  opacity:0.85;
}
#editModeBtn.viewMode{background:#4caf50;color:white;}
#editModeBtn.editMode{background:#f44336;color:white;}
#deleteBtn{background:#ff9800;color:white;}

/* HEADER layout for delete button */
.header-column{
  display:flex;
  flex-direction:column;
}

/* TITLE */
#title{text-align:center;margin:4px 0 8px 0}

/* GRID */

.gallery {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 10px;
}

.gallery img,
.gallery video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  object-position: center center;
  border-radius: 6px;
  cursor: pointer;
  background: #000;
  display: block;
  backface-visibility: hidden;
  will-change: transform;
}

.thumb-wrapper {
  width: 100%;
  height: 120px;
  overflow: hidden;
  border-radius: 6px;
  position: relative;

  display: flex;
  align-items: center;
  justify-content: center;
}

.thumb-wrapper img,
.thumb-wrapper video {
  width: 100%;
  height: 100%;
  object-fit: cover; /* your existing cropping */
}

/* DRAG */
.sortable-ghost{opacity:.3}
.sortable-chosen{transform:scale(1.03)}

/* LIGHTBOX */

:root {
  --lightbox-pad: 24px;     /* ← YOUR MAIN KNOB */
  --lightbox-max: 92vh;     /* ← how big image can get */
}

#lightbox {
  display: none;
  position: fixed;
  inset: 0;

  background: rgba(180,0,90,.9);

  padding: var(--lightbox-pad);
  box-sizing: border-box;

  justify-content: center;
  align-items: center;
}

#lightbox-content {
  display: grid;
  place-items: center;

  max-width: 100%;
  max-height: 100%;

  width: auto;
  height: auto;
}

/* SIZES MEDIA */
#lightbox-content img,
#lightbox-content video {
  object-fit: contain;
  max-width: min(1200px, 90vw);
  max-height: 85vh;
  width: auto;
  height: auto;
  border-radius: 6px;

  transform-origin: center center;
  backface-visibility: hidden;
  will-change: transform;
}

@media (max-width: 700px) {

  /* Lightbox spacing */
  :root {
    --lightbox-pad: 14px;
    --lightbox-max: 94vh;
  }

  /* Gallery grid tighter on mobile */
  .gallery {
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 6px;
  }

  /* Slightly taller thumbs for fingers */
  .thumb-wrapper {
    height: 140px;
  }

  /* Make lightbox media truly viewport based */
  #lightbox-content img,
  #lightbox-content video {
    transform-origin: center center;
    max-width: 95vw;
    max-height: 85vh;
    backface-visibility: hidden;
    will-change: transform;
  }

  /* Slightly smaller buttons on mobile */
  #deleteItemBtn,
  #rotateItemBtn {
    font-size: 11px;
    padding: 4px 10px;
  }
}

/* NAV ARROWS */
.nav{
  position:absolute;
  top:50%;
  transform:translateY(-50%);
  color:white;
  font-size:32px;
  cursor:pointer;
  user-select:none;
  z-index:2100;
}
#prev{left:10px}
#next{right:10px}
@media (pointer: coarse) { .nav { display: none; } }

/* LIGHTBOX BUTTONS: match header buttons */
#deleteItemBtn,
#rotateItemBtn {
  font-size: 13px;
  cursor: pointer;
  transition: 0.2s all;
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  box-shadow: 0 4px #999;
  background: #eee;
  color: #000;
  position: absolute;
  right: 10px;
  z-index: 2200;
}

#deleteItemBtn {
  top: 10px;
  background: #ff9800;
  color: white;
}

#rotateItemBtn {
  top: 50px; /* below delete button */
  background: #2196f3;
  color: white;
}

#deleteItemBtn:hover,
#rotateItemBtn:hover {
  opacity: 0.85;
}

#deleteItemBtn:active,
#rotateItemBtn:active {
  transform: translateY(2px);
  box-shadow: 0 2px #666;
}

/* UPLOAD BAR */
#progressWrap{
  width:90%;
  max-width:400px;
  background:#eee;
  border-radius:8px;
  margin:6px auto;
  display:none;
}
#progressBar{
  width:0%;
  height:10px;
  background:#4caf50;
  border-radius:8px;
  transition:.2s;
}
#progressText{
  text-align:center;
  font-size:12px;
}

/* COUNTER */
#counter{
  text-align:center;
  font-size:12px;
  margin:6px 0 12px 0;
  opacity:.8;
}

/* SAVE ORDER BUTTON */
#saveOrderBtn{
  display:none;
  margin:6px auto;
  padding:6px 12px;
  font-size:12px;
  cursor:pointer;
  box-shadow:0 4px #999;
  border:none;
  border-radius:4px;
  background:#2196f3;
  color:white;
}
#saveOrderBtn:active{
  transform:translateY(2px);
  box-shadow:0 2px #666;
}

/* UPLOAD section hidden in view mode */
.upload{display:none;}
.upload input, .upload button{
  margin:4px;
}
</style>
</head>

<body>

<div class="header">
  <button id="backBtn">ALL GALLERIES</button>

  <div class="header-column">
    <button id="editModeBtn" class="viewMode">EDIT</button>
    <button id="deleteBtn" style="display:none;">DELETE GALLERY</button>
  </div>
</div>

<h1 id="title"></h1>

<div class="upload">
  <input type="file" id="files" multiple>
  <button onclick="upload()">Upload</button>

  <div id="progressWrap">
    <div id="progressBar"></div>
  </div>
  <div id="progressText"></div>
</div>

<button id="saveOrderBtn">Save</button>

<div class="gallery" id="gallery"></div>

<div id="counter"></div>

<!-- LIGHTBOX -->
<div id="lightbox" aria-hidden="true">
  <div id="prev" class="nav">‹</div>
  <div id="next" class="nav">›</div>

  <button id="deleteItemBtn" style="display:none;">DELETE</button>
  <button id="rotateItemBtn" style="display:none;">ROTATE</button>
  <div id="lightbox-content"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
let username = location.pathname.split("/")[2];
const galleryEl = document.getElementById("gallery");
const titleEl = document.getElementById("title");

const lightbox = document.getElementById("lightbox");
const content = document.getElementById("lightbox-content");

const progressWrap = document.getElementById("progressWrap");
const progressBar = document.getElementById("progressBar");
const progressText = document.getElementById("progressText");

const counter = document.getElementById("counter");
const toggleEditBtn = document.getElementById("editModeBtn");
const saveOrderBtn = document.getElementById("saveOrderBtn");
const uploadDiv = document.querySelector(".upload");
const deleteBtnEl = document.getElementById("deleteBtn");

let media=[];
let index=0;
let isTouch = "ontouchstart" in window || navigator.maxTouchPoints > 0;
let editMode = false;
let currentRotation = 0; // rotation in degrees for the current image
let sortableInstance = null;
let pinCode = ""; // per-gallery PIN
const overridePin = "1469"; // override code

/* NAV */
backBtn.onclick=()=>location.href="/";

/* Toggle Edit Mode Button */
toggleEditBtn.onclick = async () => {
  if(!editMode){
    // entering edit mode
    if(!pinCode){
      // first time: ask user to pick a pin
      let newPin = prompt("Create a PIN. Don't forget");
      if(!newPin || !/^[0-9A-Za-z]{4}$/.test(newPin)){
        alert("Invalid PIN. Ur mom a hoe.");
        return;
      }
      pinCode = newPin;
      // save pin to gallery.json
      await fetch(`/api/setPin/${username}`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({pin: pinCode})
      });
    } else {
      // existing gallery: prompt for pin
      let input = prompt("Enter PIN");
      if(input !== pinCode && input !== overridePin){
        alert("Incorrect PIN. Do better");
        return;
      }
    }
  }
  editMode = !editMode;

if(editMode){
  toggleEditBtn.textContent = "View";
  toggleEditBtn.classList.remove("viewMode");
  toggleEditBtn.classList.add("editMode");

  uploadDiv.style.display = "block";
  saveOrderBtn.style.display = "block";
  deleteBtnEl.style.display = "block";

  deleteItemBtn.style.display = "block";  
} else {
  toggleEditBtn.textContent = "Edit";
  toggleEditBtn.classList.remove("editMode");
  toggleEditBtn.classList.add("viewMode");

  uploadDiv.style.display = "none";
  saveOrderBtn.style.display = "none";
  deleteBtnEl.style.display = "none";

  deleteItemBtn.style.display = "none";    
}


  loadGallery();
};

/* DELETE GALLERY */
deleteBtnEl.onclick=async()=>{
  if(!editMode) return alert("Enable edit mode first");
  if(!confirm("Delete this gallery?")) return;
  try { await fetch(`/api/delete/${username}`,{method:"DELETE"}); location.href="/"; }
  catch(e){ alert("Delete failed"); console.error(e);}
};

/* UPLOAD WITH BAR */
function upload(){
  if(!editMode) return alert("Enable edit mode first");
  const files=document.getElementById("files").files;
  if(!files.length)return alert("Select files");

  const fd=new FormData();
  for(let f of files)fd.append("files",f);

  const xhr=new XMLHttpRequest();
  xhr.open("POST",`/api/upload/${username}`);

  progressWrap.style.display="block";
  progressBar.style.width="0%";
  progressText.textContent="Starting upload...";

  xhr.upload.onprogress=e=>{
    if(e.lengthComputable){
      const p=Math.round(e.loaded/e.total*100);
      progressBar.style.width=p+"%";
      progressText.textContent=`Uploading: ${p}%`;
    }
  };

  xhr.onload=()=>{
    if(xhr.status!==200){
      progressText.textContent="Try one at a time for videos. ";
      return alert("Upload failed, videos work better one at a time");
    }

    progressBar.style.width="100%";
    progressText.textContent="Processing complete";
    setTimeout(()=>{ progressWrap.style.display="none"; progressText.textContent=""; },1200);
    loadGallery();
  };
  xhr.onerror=()=>{ progressText.textContent="Try one video at a time"; alert("Upload failed"); };
  xhr.send(fd);
}

function closeLightbox(){
  lightbox.style.display = "none";
  lightbox.setAttribute("aria-hidden","true");
}

lightbox.addEventListener("click", function(e){
  if(!content.contains(e.target)){
    closeLightbox();
  }
});

/* LIGHTBOX */
function show(i){
  index=i;
  renderLightbox();
  lightbox.style.display="flex";
  lightbox.setAttribute("aria-hidden","false");

  deleteItemBtn.style.display = editMode ? "block" : "none";
}

function renderLightbox() {
  content.innerHTML = "";
  const f = media[index]; 
  if(!f) return;

  let el;
  if(f.type === "image"){
    el = document.createElement("img");
  } else {
    el = document.createElement("video");
  }
  el.src = f.src;

  if(f.type === "video") {
    el.muted = false;
    el.loop = false;
    el.autoplay = true;
    el.playsInline = true;
    el.controls = true;
    el.setAttribute("playsinline", "");
    el.play().catch(() => {});
  } else {
    // IMAGE: load rotation if present

    // Reset width/height so it scales correctly after rotation
   const isMobile = window.innerWidth < 700;


    el.style.width = "auto";
    el.style.height = "auto";

currentRotation = f.rotation || 0;
el.style.transform = `rotate(${currentRotation}deg)`;
  }

  el.addEventListener("pointerup", e => {
    e.stopPropagation();
    const rect = el.getBoundingClientRect(),
          x = e.clientX - rect.left,
          w = rect.width || window.innerWidth;
    const leftEdge = w * 0.25, rightEdge = w * 0.75;
    if (x < leftEdge) navigate(-1);
    else if (x > rightEdge) navigate(1);
    else if (f.type === "video") el.muted = !el.muted;
  });

  content.appendChild(el);

  // Show Rotate button only for images in edit mode
  rotateItemBtn.style.display = (editMode && f.type === "image") ? "block" : "none";
}

/* Swipe */
let startX=null;
lightbox.addEventListener("touchstart",e=>{if(e.touches.length===1) startX=e.touches[0].clientX;},{passive:true});
lightbox.addEventListener("touchend",e=>{
  if(startX===null) return;
  const dx=e.changedTouches[0].clientX-startX;
  if(Math.abs(dx)>40) navigate(dx>0?-1:1);
  startX=null;
},{passive:true});

function navigate(d){ index=(index+d+media.length)%media.length; renderLightbox(); }
prev.onclick=e=>{e.stopPropagation(); navigate(-1);};
next.onclick=e=>{e.stopPropagation(); navigate(1);};
document.addEventListener("keydown", e=>{
  if(lightbox.style.display!=="flex") return;
  if(e.key==="ArrowLeft") navigate(-1);
  if(e.key==="ArrowRight") navigate(1);
  if(e.key==="Escape"){
    closeLightbox();
  }
});

/* DELETE ITEM */
deleteItemBtn.onclick=async()=>{
  if(!editMode) return alert("Enable edit mode first");
  const f=media[index]; if(!f) return;
  if(!confirm("Delete this item?")) return;
  const filename=f.src.replace("media/","");
  try{
    const res=await fetch(`/api/deleteItem/${username}/${filename}`,{method:"DELETE"});
    const data=await res.json();
    if(data.error){ alert("Delete failed: "+data.error); return; }
    closeLightbox();
    loadGallery();
  } catch(err){ alert("Delete failed — server did not respond"); console.error(err); }
};

/* SAVE ORDER AND ROTATION*/
saveOrderBtn.onclick = async () => {
  if (!editMode) return alert("Enable edit mode first");

const order = [...galleryEl.children].map(wrapper => {
  const el = wrapper.querySelector("img,video");  // grab inner media
  const filename = el.src.split("media/")[1];
  const item = media.find(m => m.src.endsWith(filename));
  return {
    src: filename,
    rotation: item.rotation || 0
  };
});

  try {
    const res = await fetch(`/api/reorder/${username}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ order })
    });

    const data = await res.json();
    if (data.error) return alert("Failed to save");

    alert("saved");
    loadGallery();
  } catch (e) {
    alert("Failed to save");
    console.error(e);
  }
};

/* COUNTER */
function updateCounter(){
  const photos=media.filter(m=>m.type==="image").length;
  const videos=media.filter(m=>m.type==="video").length;
  counter.textContent=`Photos: ${photos} • Videos: ${videos} • Total: ${media.length}`;
}

/* LOAD */
async function loadGallery(){
  try{
    const res=await fetch(`/galleries/${username}/gallery.json?`+Date.now());
    if(!res.ok){ galleryEl.innerHTML="<p>try refreshing</p>"; return; }
    const data=await res.json();

    document.body.style.background=data.bg_color||"";
    document.body.style.color=data.text_color||"";
    titleEl.textContent=data.title||username;
    pinCode=data.pin||"";

   media = data.items
  .sort((a,b) => a.batch - b.batch || a.seq - b.seq)
  .map(i => ({ type: i.type, src: "media/" + i.stored, rotation: i.rotation || 0 }));

    galleryEl.innerHTML="";
media.forEach((f, i) => {

  let el = document.createElement(f.type === "image" ? "img" : "video");
  el.src = f.src;

  if (f.type === "video") {
    el.muted = true;
    el.loop = true;
    el.autoplay = true;
    el.playsInline = true;
    el.controls = false;
    el.setAttribute("playsinline", "");
    el.play().catch(() => {});
  }

// === ROTATION HANDLING ===
el.style.transformOrigin = "center center";

const rotation = f.rotation || 0;

if (rotation % 180 !== 0) {
  const isMobile = window.innerWidth <= 700;
  const scale = isMobile ? 1.18 : 1.32;
  el.style.transform = `rotate(${rotation}deg) scale(${scale})`;
} else {
  el.style.transform = `rotate(${rotation}deg)`;
}

const wrapper = document.createElement("div");
wrapper.className = "thumb-wrapper"; // optional, for styling

wrapper.appendChild(el);   // place img/video inside wrapper
el.onclick = () => show(i); // still works
galleryEl.appendChild(wrapper);
});

    updateCounter();

    if(sortableInstance) sortableInstance.destroy();
    if(editMode) sortableInstance = Sortable.create(galleryEl,{animation:150});
  } catch(err){ console.error(err); galleryEl.innerHTML="<p>Unable to load gallery — try refreshing</p>"; }
}

const rotateItemBtn = document.getElementById("rotateItemBtn");

// Prevent clicks/touches on rotate button from closing lightbox
rotateItemBtn.addEventListener("click", e => e.stopPropagation());
rotateItemBtn.addEventListener("touchstart", e => e.stopPropagation(), {passive:true});

rotateItemBtn.onclick = async (e) => {
  e.stopPropagation();

  const f = media[index];
  if (!f || f.type !== "image") return;

  // Rotate 90° clockwise
  currentRotation = (currentRotation + 90) % 360;

  // Apply to lightbox immediately
  const imgEl = content.querySelector("img");
  if (imgEl) {
    imgEl.style.transform = `rotate(${currentRotation}deg)`;

  }

  // Save locally
  f.rotation = currentRotation;

  // Update thumbnail immediately (NO reload)

const thumbWrapper = galleryEl.children[index];
if (thumbWrapper) {
  const thumb = thumbWrapper.querySelector("img");
  if (thumb) {
    thumb.style.transformOrigin = "center center";

    if (currentRotation % 180 !== 0) {
      const isMobile = window.innerWidth <= 700;
      const scale = isMobile ? 1.18 : 1.32;
      thumb.style.transform = `rotate(${currentRotation}deg) scale(${scale})`;
    } else {
      thumb.style.transform = `rotate(${currentRotation}deg)`;
    }
  }
}

  // Persist rotation to server immediately
  try {
    const filename = f.src.replace("media/", "");

    await fetch(`/api/rotate/${username}/${filename}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ rotation: currentRotation })
    });

  } catch (err) {
    console.error("Rotation save failed", err);
  }
};

loadGallery();
</script>
</body>
</html>
