<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Gallery</title>
<link rel="stylesheet" href="/styles.css"/>

<style>
body{margin:0;font-family:Arial,Helvetica,sans-serif}

/* HEADER */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px;
}
.header button{
  background:none;
  border:none;
  font-size:13px;
  cursor:pointer;
  transition:opacity .2s;
}
.header button:hover{opacity:.5}

#title{text-align:center;margin:4px 0 8px 0}

/* GRID */
.gallery{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(130px,1fr));
  gap:8px;
  padding:10px;
}
.gallery img,
.gallery video{
  width:100%;
  height:100%;
  object-fit:cover;
  border-radius:6px;
  cursor:pointer;
  background:#000;
}

/* DRAG */
.sortable-ghost{opacity:.3}
.sortable-chosen{transform:scale(1.03)}

/* LIGHTBOX */
#lightbox{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.9);
  justify-content:center;
  align-items:center;
  z-index:2000;
}
#lightbox-content{
  position:relative;
  max-width:90vw;
  max-height:90vh;
}
#lightbox-content img,
#lightbox-content video{
  max-width:100%;
  max-height:100%;
  border-radius:8px;
  display:block;
}

/* NAV ARROWS */
.nav{
  position:absolute;
  top:50%;
  transform:translateY(-50%);
  color:white;
  font-size:32px;
  cursor:pointer;
  user-select:none;
  z-index:2100;
}
#prev{left:10px}
#next{right:10px}

/* hide arrows on touch devices (phones) */
@media (pointer: coarse) {
  .nav { display: none; }
}

/* delete item button */
#deleteItemBtn{
  position:absolute;
  top:10px;
  right:10px;
  background:none;
  border:none;
  color:white;
  z-index:2200;
}

/* UPLOAD BAR */
#progressWrap{
  width:90%;
  max-width:400px;
  background:#eee;
  border-radius:8px;
  margin:6px auto;
  display:none;
}
#progressBar{
  width:0%;
  height:10px;
  background:#4caf50;
  border-radius:8px;
  transition:.2s;
}
#progressText{
  text-align:center;
  font-size:12px;
}

/* COUNTER */
#counter{
  text-align:center;
  font-size:12px;
  margin:6px 0 12px 0;
  opacity:.8;
}
</style>
</head>

<body>

<div class="header">
  <button id="backBtn">ALL GALLERIES</button>
  <button id="deleteBtn">DELETE GALLERY</button>
</div>

<h1 id="title"></h1>

<div class="upload">
  <input type="file" id="files" multiple>
  <button onclick="upload()">Upload</button>

  <div id="progressWrap">
    <div id="progressBar"></div>
  </div>
  <div id="progressText"></div>
</div>

<div class="gallery" id="gallery"></div>

<div id="counter"></div>

<!-- LIGHTBOX -->
<div id="lightbox" aria-hidden="true">
  <div id="prev" class="nav">â€¹</div>
  <div id="next" class="nav">â€º</div>

  <button id="deleteItemBtn">DELETE</button>
  <div id="lightbox-content"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
let username = location.pathname.split("/")[2];

const galleryEl = document.getElementById("gallery");
const titleEl = document.getElementById("title");

const lightbox = document.getElementById("lightbox");
const content = document.getElementById("lightbox-content");

const progressWrap = document.getElementById("progressWrap");
const progressBar = document.getElementById("progressBar");
const progressText = document.getElementById("progressText");

const counter = document.getElementById("counter");

let media=[];
let index=0;

const isTouch = "ontouchstart" in window || navigator.maxTouchPoints > 0;

/* NAV */
backBtn.onclick=()=>location.href="/";

deleteBtn.onclick=async()=>{
  if(!confirm("Delete this gallery?"))return;
  try {
    await fetch(`/api/delete/${username}`,{method:"DELETE"});
    location.href="/";
  } catch(e){
    alert("Delete failed â€” server error");
    console.error(e);
  }
};

/* UPLOAD WITH BAR */
function upload(){
  const files=document.getElementById("files").files;
  if(!files.length)return alert("Select files");

  const fd=new FormData();
  for(let f of files)fd.append("files",f);

  const xhr=new XMLHttpRequest();
  xhr.open("POST",`/api/upload/${username}`);

  progressWrap.style.display="block";
  progressBar.style.width="0%";
  progressText.textContent="Starting upload...";

  xhr.upload.onprogress=e=>{
    if(e.lengthComputable){
      const p=Math.round(e.loaded/e.total*100);
      progressBar.style.width=p+"%";
      progressText.textContent=`Uploading: ${p}%`;
    }
  };

  xhr.onload=()=>{
    if(xhr.status!==200){
      progressText.textContent=
        "Try one at a time â€” videos are heavy ðŸ™ƒ";
      return alert("Upload failed â€” videos work better one at a time");
    }

    progressBar.style.width="100%";
    progressText.textContent="Processing complete âœ…";

    setTimeout(()=>{
      progressWrap.style.display="none";
      progressText.textContent="";
    },1200);

    loadGallery();
  };

  xhr.onerror=()=>{
    progressText.textContent=
      "Try one at a time â€” videos are heavy ðŸ™ƒ";
    alert("Upload failed â€” videos work better one at a time");
  };

  xhr.send(fd);
}

/* LIGHTBOX rendering with side-tap navigation + center video control */
function show(i){
  index=i;
  renderLightbox();
  lightbox.style.display="flex";
  lightbox.setAttribute("aria-hidden","false");
}

function renderLightbox(){
  content.innerHTML="";
  const f = media[index];
  if(!f) return;

  let el;
  if(f.type==="image"){
    el = document.createElement("img");
    el.src = f.src;
  } else {
    el = document.createElement("video");
    el.src = f.src;
    el.controls = true;
    el.playsInline = true;
    el.setAttribute("playsinline","");
    el.muted = true;      // start muted
    el.autoplay = true;
    el.loop = true;
    // attempt play to ensure frame appears
    el.play().catch(()=>{});
  }

  // pointerup handler that interprets taps:
  // - if tap is on leftmost 25% => prev
  // - if tap is on rightmost 25% => next
  // - else (center) => if video toggle mute/play; if image do nothing
  el.addEventListener("pointerup", e => {
    e.stopPropagation();

    const rect = el.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const w = rect.width || window.innerWidth;

    const leftEdge = w * 0.25;
    const rightEdge = w * 0.75;

    if (x < leftEdge) {
      navigate(-1);
      return;
    }

    if (x > rightEdge) {
      navigate(1);
      return;
    }

    // center tap
    if (f.type === "video") {
      // toggle mute (and try to play if unmuted)
      if (el.muted) {
        el.muted = false;
        el.play().catch(()=>{});
      } else {
        el.muted = true;
      }
    }
    // images: center tap intentionally does nothing (prevents accidental nav)
  });

  // prevent touch dragging on the media element from selecting page content
  el.addEventListener("touchstart", e => { e.stopPropagation(); }, { passive: true });

  content.appendChild(el);
}

/* SWIPE handling on lightbox (touch) - does not interfere with tap */
let startX = null;
lightbox.addEventListener("touchstart", e => {
  if (e.touches.length === 1) startX = e.touches[0].clientX;
}, { passive: true });

lightbox.addEventListener("touchend", e => {
  if (startX === null) return;
  const dx = e.changedTouches[0].clientX - startX;
  const threshold = 40; // px
  if (Math.abs(dx) > threshold) {
    navigate(dx > 0 ? -1 : 1);
  }
  startX = null;
}, { passive: true });

/* ARROWS + KEYS */
function navigate(d){
  index=(index+d+media.length)%media.length;
  renderLightbox();
}

prev.onclick=e=>{ e.stopPropagation(); navigate(-1); };
next.onclick=e=>{ e.stopPropagation(); navigate(1); };

document.addEventListener("keydown", e=>{
  if(lightbox.style.display!=="flex")return;
  if(e.key==="ArrowLeft")navigate(-1);
  if(e.key==="ArrowRight")navigate(1);
  if(e.key==="Escape"){
    lightbox.style.display="none";
    lightbox.setAttribute("aria-hidden","true");
  }
});

lightbox.onclick=e=>{
  if(!content.contains(e.target)){
    lightbox.style.display="none";
    lightbox.setAttribute("aria-hidden","true");
  }
};

/* DELETE ITEM WITH REAL ERRORS */
deleteItemBtn.onclick=async()=>{
  const f=media[index];
  if(!f)return;

  if(!confirm("Delete this item?"))return;

  const filename=f.src.replace("media/","");

  try{
    const res=await fetch(
      `/api/deleteItem/${username}/${filename}`,
      {method:"DELETE"}
    );

    const data=await res.json();

    if(data.error){
      alert("Delete failed: "+data.error);
      return;
    }

    lightbox.style.display="none";
    lightbox.setAttribute("aria-hidden","true");
    loadGallery();

  }catch(err){
    alert("Delete failed â€” server did not respond");
    console.error(err);
  }
};

/* COUNTER */
function updateCounter(){
  const photos=media.filter(m=>m.type==="image").length;
  const videos=media.filter(m=>m.type==="video").length;

  counter.textContent=
    `Photos: ${photos} â€¢ Videos: ${videos} â€¢ Total: ${media.length}`;
}

/* LOAD */
async function loadGallery(){
  try {
    const res=await fetch(
      `/galleries/${username}/gallery.json?`+Date.now()
    );

    if (!res.ok) {
      galleryEl.innerHTML = "<p>Unable to load gallery â€” try refreshing</p>";
      return;
    }

    const data=await res.json();

    document.body.style.background=data.bg_color || "";
    document.body.style.color=data.text_color || "";
    titleEl.textContent=data.title || username;

    media=data.items
      .sort((a,b)=>a.batch-b.batch||a.seq-b.seq)
      .map(i=>({ type:i.type, src:"media/"+i.stored }));

    galleryEl.innerHTML="";

    media.forEach((f,i)=>{
      let el=document.createElement(f.type==="image"?"img":"video");

      el.src=f.src;

      if(f.type==="video"){
        // make gallery videos autoplay silently like moving photos
        el.muted = true;
        el.loop = true;
        el.autoplay = true;
        el.playsInline = true;
        el.setAttribute("playsinline","");
        // attempt to play so poster/frame appears
        el.play && el.play().catch(()=>{});
      }

      el.onclick=()=>show(i);

      galleryEl.appendChild(el);
    });

    updateCounter();

    /* DRAG REORDER (unchanged behavior) */
    Sortable.create(galleryEl,{
      animation:150,
      onEnd:async()=>{
        const order=[...galleryEl.children].map(
          c=>media.find(m=>m.src===c.src).src
        );

        try{
          await fetch(`/api/reorder/${username}`,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({order})
          });
        }catch(e){
          console.error("reorder failed", e);
        }
      }
    });

  } catch(err) {
    console.error(err);
    galleryEl.innerHTML = "<p>Unable to load gallery â€” try refreshing</p>";
  }
}

loadGallery();
</script>
</body>
</html>
