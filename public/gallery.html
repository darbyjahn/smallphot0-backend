<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Gallery</title>
<link rel="stylesheet" href="/styles.css"/>

<style>
body{margin:0;font-family:Arial,Helvetica,sans-serif}

/* HEADER */
.header{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  align-items:center;
  padding:10px;
}
.header button{
  font-size:13px;
  cursor:pointer;
  transition:0.2s all;
  padding:6px 12px;
  border:none;
  border-radius:4px;
  box-shadow:0 4px #999;
  background:#eee;
}
.header button:active{
  transform:translateY(2px);
  box-shadow:0 2px #666;
}
.header button:hover{
  opacity:0.85;
}
#editModeBtn.viewMode{background:#4caf50;color:white;}
#editModeBtn.editMode{background:#f44336;color:white;}
#deleteBtn{background:#ff9800;color:white;}

/* HEADER layout for delete button */
.header-column{
  display:flex;
  flex-direction:column;
}

/* TITLE */
#title{text-align:center;margin:4px 0 8px 0}

/* GRID */
.gallery {
  max-width: 1100px;
  margin: 0 auto;
  padding: 14px;
}
.gallery img,
.gallery video{
  width:100%;
  height:100%;
  object-fit:cover;
  border-radius:6px;
  cursor:pointer;
  background:#000;
}

/* DRAG */
.sortable-ghost{opacity:.3}
.sortable-chosen{transform:scale(1.03)}

/* LIGHTBOX */
:root {
  --lightbox-pad: 24px;
  --lightbox-max: 92vh;
}
#lightbox {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.92);
  padding: var(--lightbox-pad);
  box-sizing: border-box;
  justify-content: center;
  align-items: center;
}
#lightbox-content {
  display: grid;
  place-items: center;
  max-width: 100%;
  max-height: 100%;
  width: auto;
  height: auto;
}
#lightbox-content img,
#lightbox-content video {
  object-fit: contain;
  max-width: min(1400px, 100%);
  max-height: var(--lightbox-max);
  width: auto;
  height: auto;
  border-radius: 6px;
}
@media (max-width: 700px) {
  :root {
    --lightbox-pad: 14px;
    --lightbox-max: 94vh;
  }
}

/* NAV ARROWS */
.nav{
  position:absolute;
  top:50%;
  transform:translateY(-50%);
  color:white;
  font-size:32px;
  cursor:pointer;
  user-select:none;
  z-index:2100;
}
#prev{left:10px}
#next{right:10px}
@media (pointer: coarse) { .nav { display: none; } }

/* DELETE ITEM BUTTON */
#deleteItemBtn{
  position:absolute;
  top:10px;
  right:10px;
  background:none;
  border:none;
  color:white;
  z-index:2200;
}

/* UPLOAD BAR */
#progressWrap{
  width:90%;
  max-width:400px;
  background:#eee;
  border-radius:8px;
  margin:6px auto;
  display:none;
}
#progressBar{
  width:0%;
  height:10px;
  background:#4caf50;
  border-radius:8px;
  transition:.2s;
}
#progressText{
  text-align:center;
  font-size:12px;
}

/* COUNTER */
#counter{
  text-align:center;
  font-size:12px;
  margin:6px 0 12px 0;
  opacity:.8;
}

/* SAVE ORDER BUTTON */
#saveOrderBtn{
  display:none;
  margin:6px auto;
  padding:6px 12px;
  font-size:12px;
  cursor:pointer;
  box-shadow:0 4px #999;
  border:none;
  border-radius:4px;
  background:#2196f3;
  color:white;
}
#saveOrderBtn:active{
  transform:translateY(2px);
  box-shadow:0 2px #666;
}

/* UPLOAD section hidden in view mode */
.upload{display:none;}
.upload input, .upload button{margin:4px}

/* TRASH CAN */
#trashCan {
  display: none;
  position: fixed;
  top: 10px;
  right: 10px;
  width: 60px;
  max-width: 10vw;
  cursor: pointer;
  z-index:3000;
  transition: transform 0.2s ease;
}
#trashCan.drag-over { transform: scale(1.3); }
@keyframes rattle {
  0% { transform: rotate(0deg); }
  25% { transform: rotate(-15deg); }
  50% { transform: rotate(15deg); }
  75% { transform: rotate(-10deg); }
  100% { transform: rotate(0deg); }
}
#trashCan.rattle { animation: rattle 0.3s ease; }
</style>
</head>

<body>

<div class="header">
  <button id="backBtn">ALL GALLERIES</button>
  <div class="header-column">
    <button id="editModeBtn" class="viewMode">Edit</button>
    <button id="deleteBtn" style="display:none;">DELETE GALLERY</button>
  </div>
</div>

<h1 id="title"></h1>

<!-- TRASH CAN -->
<img id="trashCan" src="/trash.png" alt="Trash" />

<div class="upload">
  <input type="file" id="files" multiple>
  <button onclick="upload()">Upload</button>

  <div id="progressWrap">
    <div id="progressBar"></div>
  </div>
  <div id="progressText"></div>
</div>

<button id="saveOrderBtn">Save Order</button>

<div class="gallery" id="gallery"></div>
<div id="counter"></div>

<!-- LIGHTBOX -->
<div id="lightbox" aria-hidden="true">
  <div id="prev" class="nav">â€¹</div>
  <div id="next" class="nav">â€º</div>
  <button id="deleteItemBtn" style="display:none;">DELETE</button>
  <div id="lightbox-content"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
let username = location.pathname.split("/")[2];
const galleryEl = document.getElementById("gallery");
const titleEl = document.getElementById("title");
const lightbox = document.getElementById("lightbox");
const content = document.getElementById("lightbox-content");
const progressWrap = document.getElementById("progressWrap");
const progressBar = document.getElementById("progressBar");
const progressText = document.getElementById("progressText");
const counter = document.getElementById("counter");
const toggleEditBtn = document.getElementById("editModeBtn");
const saveOrderBtn = document.getElementById("saveOrderBtn");
const uploadDiv = document.querySelector(".upload");
const deleteBtnEl = document.getElementById("deleteBtn");
const deleteItemBtn = document.getElementById("deleteItemBtn");
const trashCan = document.getElementById("trashCan");

let media=[], index=0, isTouch = "ontouchstart" in window || navigator.maxTouchPoints>0;
let editMode=false, sortableInstance=null, draggedEl=null;
let pinCode="", overridePin="1469";

/* NAV */
document.getElementById("backBtn").onclick = ()=>location.href="/";

/* TOGGLE EDIT MODE */
toggleEditBtn.onclick = async () => {
  if(!editMode){
    if(!pinCode){
      let newPin = prompt("Pick a 4-digit PIN:");
      if(!newPin || !/^[0-9A-Za-z]{4}$/.test(newPin)){ alert("Invalid PIN"); return; }
      pinCode=newPin;
      await fetch(`/api/setPin/${username}`,{
        method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({pin:pinCode})
      });
    } else {
      let input = prompt("Enter 4-digit PIN:");
      if(input !== pinCode && input !== overridePin){ alert("Incorrect PIN"); return; }
    }
  }
  editMode=!editMode;
  toggleEditBtn.textContent=editMode?"View":"Edit";
  toggleEditBtn.className = editMode?"editMode":"viewMode";
  uploadDiv.style.display = editMode?"block":"none";
  saveOrderBtn.style.display = editMode?"block":"none";
  deleteBtnEl.style.display = editMode?"block":"none";
  deleteItemBtn.style.display = editMode?"block":"none";
  trashCan.style.display = editMode?"block":"none";
  loadGallery();
};

/* DELETE GALLERY */
deleteBtnEl.onclick = async ()=>{
  if(!editMode) return alert("Enable edit mode first");
  if(!confirm("Delete this gallery?")) return;
  try{ await fetch(`/api/delete/${username}`, {method:"DELETE"}); location.href="/"; }
  catch(e){ alert("Delete failed"); console.error(e); }
};

/* UPLOAD */
function upload(){
  if(!editMode) return alert("Enable edit mode first");
  const files=document.getElementById("files").files;
  if(!files.length) return alert("Select files");
  const fd=new FormData();
  for(let f of files) fd.append("files",f);
  const xhr=new XMLHttpRequest();
  xhr.open("POST", `/api/upload/${username}`);
  progressWrap.style.display="block";
  progressBar.style.width="0%"; progressText.textContent="Starting upload...";
  xhr.upload.onprogress=e=>{
    if(e.lengthComputable){
      let p=Math.round(e.loaded/e.total*100);
      progressBar.style.width=p+"%";
      progressText.textContent=`Uploading: ${p}%`;
    }
  };
  xhr.onload=()=>{
    if(xhr.status!==200){ progressText.textContent="Try one at a time for videos."; alert("Upload failed"); return; }
    progressBar.style.width="100%"; progressText.textContent="Processing complete âœ…";
    setTimeout(()=>{progressWrap.style.display="none"; progressText.textContent="";},1200);
    loadGallery();
  };
  xhr.onerror = ()=>{ alert("Upload failed"); progressText.textContent="Try one at a time â€” videos are heavy ðŸ™ƒ"; };
  xhr.send(fd);
}

/* LIGHTBOX */
function closeLightbox(){ lightbox.style.display="none"; lightbox.setAttribute("aria-hidden","true"); }
lightbox.addEventListener("click", e=>{ if(!content.contains(e.target)) closeLightbox(); });

function show(i){
  index=i; renderLightbox();
  lightbox.style.display="flex"; lightbox.setAttribute("aria-hidden","false");
  deleteItemBtn.style.display=editMode?"block":"none";
}
function renderLightbox(){
  content.innerHTML=""; const f=media[index]; if(!f) return;
  let el = f.type==="image"?document.createElement("img"):document.createElement("video");
  el.src=f.src;
  if(f.type==="video"){
    el.muted=false; el.loop=false; el.autoplay=true; el.playsInline=true; el.controls=true;
    el.setAttribute("playsinline",""); el.play().catch(()=>{});
  }
  el.addEventListener("pointerup", e=>{
    e.stopPropagation();
    const rect=el.getBoundingClientRect(), x=e.clientX-rect.left, w=rect.width||window.innerWidth;
    if(x<w*0.25) navigate(-1);
    else if(x>w*0.75) navigate(1);
    else if(f.type==="video") el.muted=!el.muted;
  });
  el.addEventListener("touchstart", e=>e.stopPropagation(), {passive:true});
  content.appendChild(el);
}

/* SWIPE */
let startX=null;
lightbox.addEventListener("touchstart", e=>{ if(e.touches.length===1) startX=e.touches[0].clientX; }, {passive:true});
lightbox.addEventListener("touchend", e=>{
  if(startX===null) return;
  const dx = e.changedTouches[0].clientX - startX;
  if(Math.abs(dx)>40) navigate(dx>0?-1:1);
  startX=null;
}, {passive:true});
function navigate(d){ index=(index+d+media.length)%media.length; renderLightbox(); }
document.getElementById("prev").onclick=e=>{ e.stopPropagation(); navigate(-1); };
document.getElementById("next").onclick=e=>{ e.stopPropagation(); navigate(1); };
document.addEventListener("keydown", e=>{
  if(lightbox.style.display!=="flex") return;
  if(e.key==="ArrowLeft") navigate(-1);
  if(e.key==="ArrowRight") navigate(1);
  if(e.key==="Escape") closeLightbox();
});

/* DELETE LIGHTBOX ITEM */
deleteItemBtn.onclick=async()=>{
  if(!editMode) return alert("Enable edit mode first");
  const f=media[index]; if(!f) return;
  if(!confirm("Delete this item?")) return;
  const filename=f.src.replace("media/","");
  try{
    const res=await fetch(`/api/deleteItem/${username}/${filename}`, {method:"DELETE"});
    const data=await res.json();
    if(data.error){ alert("Delete failed: "+data.error); return; }
    closeLightbox(); loadGallery();
  }catch(e){ alert("Delete failed â€” server did not respond"); console.error(e); }
};

/* SAVE ORDER */
saveOrderBtn.onclick = async ()=>{
  if(!editMode) return alert("Enable edit mode first");
  const order=[...galleryEl.children].map(c=>media.find(m=>m.src===c.src).src);
  try{ await fetch(`/api/reorder/${username}`, {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({order})}); alert("Order saved âœ…"); loadGallery(); }
  catch(e){ alert("Failed to save order"); console.error(e); }
};

/* COUNTER */
function updateCounter(){
  const photos=media.filter(m=>m.type==="image").length;
  const videos=media.filter(m=>m.type==="video").length;
  counter.textContent=`Photos: ${photos} â€¢ Videos: ${videos} â€¢ Total: ${media.length}`;
}

/* TRASHCAN DRAG TO DELETE */
function enableDragToTrash(){
  galleryEl.querySelectorAll("img, video").forEach(el=>{
    el.setAttribute("draggable","true");
    el.addEventListener("dragstart", e=>{ if(!editMode) e.preventDefault(); draggedEl=el; e.dataTransfer.effectAllowed="move"; });
    el.addEventListener("dragend", e=>{ draggedEl=null; trashCan.classList.remove("drag-over"); });

    if(isTouch){
      let touchStartX, touchStartY;
      el.addEventListener("touchstart", e=>{ if(!editMode) return; touchStartX=e.touches[0].clientX; touchStartY=e.touches[0].clientY; draggedEl=el; }, {passive:true});
      el.addEventListener("touchmove", e=>{
        if(!draggedEl) return;
        const t=e.touches[0], r=trashCan.getBoundingClientRect();
        if(t.clientX>r.left && t.clientX<r.right && t.clientY>r.top && t.clientY<r.bottom) trashCan.classList.add("drag-over");
        else trashCan.classList.remove("drag-over");
      }, {passive:true});
      el.addEventListener("touchend", async e=>{
        if(!draggedEl) return;
        const t=e.changedTouches[0], r=trashCan.getBoundingClientRect();
        if(t.clientX>r.left && t.clientX<r.right && t.clientY>r.top && t.clientY<r.bottom) await deleteMedia(draggedEl);
        trashCan.classList.remove("drag-over"); draggedEl=null;
      });
    }
  });
}

trashCan.addEventListener("dragover", e=>{ e.preventDefault(); trashCan.classList.add("drag-over"); });
trashCan.addEventListener("dragleave", e=>{ trashCan.classList.remove("drag-over"); });
trashCan.addEventListener("drop", async e=>{ e.preventDefault(); if(draggedEl) await deleteMedia(draggedEl); trashCan.classList.remove("drag-over"); draggedEl=null; });

async function deleteMedia(el){
  const src=el.src, filename=src.replace("media/","");
  if(!confirm("Delete this item?")) return;
  try{
    const res = await fetch(`/api/deleteItem/${username}/${filename}`, {method:"DELETE"});
    const data = await res.json();
    if(data.error){ alert("Delete failed: "+data.error); return; }
    trashCan.classList.add("rattle"); setTimeout(()=>trashCan.classList.remove("rattle"),400);
    loadGallery();
  } catch(e){ alert("Delete failed â€” server did not respond"); console.error(e); }
}

/* LOAD GALLERY */
const origLoadGallery = loadGallery;
async function loadGallery(){
  try{
    const res=await fetch(`/galleries/${username}/gallery.json?`+Date.now());
    if(!res.ok){ galleryEl.innerHTML="<p>Unable to load gallery â€” try refreshing</p>"; return; }
    const data=await res.json();
    document.body.style.background=data.bg_color||"";
    document.body.style.color=data.text_color||"";
    titleEl.textContent=data.title||username;
    pinCode=data.pin||"";
    media=data.items.sort((a,b)=>a.batch-b.batch||a.seq-b.seq).map(i=>({type:i.type, src:"media/"+i.stored}));
    galleryEl.innerHTML="";
    media.forEach((f,i)=>{
      let el = f.type==="image"?document.createElement("img"):document.createElement("video");
      el.src=f.src;
     
loadGallery();
</script>
</body>
</html>
