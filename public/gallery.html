<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gallery</title>
<link rel="stylesheet" href="/styles.css">
</head>
<body>

<button onclick="goBack()">‚Üê Back to Main Page</button>

<h1 id="title"></h1>

<div class="upload">
  <input type="file" id="files" multiple>
  <button onclick="upload()">Upload</button>
</div>

<div class="gallery" id="gallery"></div>

<div id="lightbox">
  <div id="prev" class="arrow">&#10094;</div>
  <div id="lightbox-content"></div>
  <div id="next" class="arrow">&#10095;</div>
</div>

<script>
let username = location.pathname.split("/")[2];

async function upload() {
  const files = document.getElementById("files").files;
  if (!files.length) return;
  const fd = new FormData();
  for (let f of files) fd.append("files", f);
  await fetch(`/api/upload/${username}`, { method:"POST", body: fd });
  loadGallery();
}

function goBack() { location.href = "/"; }

let galleryEl = document.getElementById("gallery");
let lightbox = document.getElementById("lightbox");
let content = document.getElementById("lightbox-content");
let prev = document.getElementById("prev");
let next = document.getElementById("next");
let index = 0;
let media = [];

async function loadGallery() {
  const res = await fetch("gallery.json");
  const g = await res.json();
  document.body.style.background = g.bg_color;
  document.body.style.color = g.text_color;
  document.getElementById("title").textContent = g.title;

  media = g.items.sort((a,b)=>a.batch-b.batch||a.seq-b.seq);
  galleryEl.innerHTML = "";
  media.forEach((i,idx)=>{
    const el = document.createElement(i.type==="video"?"video":"img");
    el.src = "media/"+i.stored;
    if(i.type==="video"){el.controls=true; el.playsInline=true;}
    el.onclick=()=>show(idx);
    galleryEl.appendChild(el);
  });
}

function show(i){
  index=i;
  content.innerHTML="";
  const f=media[i];
  let el = f.type==="video"?document.createElement("video"):document.createElement("img");
  el.src="media/"+f.stored;
  if(f.type==="video"){el.controls=true; el.autoplay=true; el.playsInline=true;}
  content.appendChild(el);
  lightbox.style.display="flex";
}

function closeLB(){ lightbox.style.display="none"; content.innerHTML=""; }
lightbox.addEventListener("click",e=>{if(!content.contains(e.target))closeLB();});
prev.onclick=e=>{e.stopPropagation();index=(index-1+media.length)%media.length;show(index);};
next.onclick=e=>{e.stopPropagation();index=(index+1)%media.length;show(index);};

loadGallery();
</script>
</body>
</html>
