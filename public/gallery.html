<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gallery</title>
<link rel="stylesheet" href="/styles.css">

<style>
/* ===== LIGHTBOX STYLES ===== */
#lightbox {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

#lightbox-content img,
#lightbox-content video {
  max-width: 90vw;
  max-height: 90vh;
  border-radius: 12px;
  object-fit: contain;
}

.arrow {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  font-size: 4em;
  color: white;
  cursor: pointer;
  user-select: none;
}

#prev { left: 10px; }
#next { right: 10px; }

@media (max-width: 700px) {
  .arrow { display: none; }
}
</style>

</head>
<body>

<button id="backBtn">â¬… Back to Galleries</button>

<button id="deleteBtn" style="background:#c33;color:white;margin-left:8px;">
  ðŸ—‘ Delete Gallery
</button>

<h1 id="title"></h1>

<div class="upload">
  <input type="file" id="files" multiple name="files">
  <button onclick="upload()">Upload</button>
</div>

<div class="gallery" id="gallery"></div>

<!-- ===== LIGHTBOX ===== -->
<div id="lightbox">
  <div id="prev" class="arrow">&#10094;</div>
  <div id="lightbox-content"></div>
  <div id="next" class="arrow">&#10095;</div>
</div>

<script>
let username = location.pathname.split("/")[2];

const galleryEl = document.getElementById("gallery");
const titleEl = document.getElementById("title");

const lightbox = document.getElementById("lightbox");
const content = document.getElementById("lightbox-content");
const prev = document.getElementById("prev");
const next = document.getElementById("next");

let media = [];
let index = 0;

const isTouch =
  "ontouchstart" in window ||
  navigator.maxTouchPoints > 0;

/* ===== BACK + DELETE ===== */

document.getElementById("backBtn").onclick =
  () => window.location.href="/";

document.getElementById("deleteBtn").onclick = async () => {

  const ok = confirm(
    "âš ï¸ This will permanently delete this gallery and ALL its media.\n\nContinue?"
  );

  if (!ok) return;

  try {
    const res = await fetch(`/api/delete/${username}`, {
      method: "DELETE"
    });

    const data = await res.json();

    if (data.error)
      return alert("Delete failed: " + data.error);

    window.location.href = "/";

  } catch (err) {
    alert("Delete failed â€” check console");
    console.error(err);
  }
};

/* ===== UPLOAD ===== */

async function upload() {
  const files = document.getElementById("files").files;
  if (!files.length) return alert("Select files");

  const fd = new FormData();
  for (let f of files) fd.append("files", f);

  try {
    const res = await fetch(`/api/upload/${username}`, {
      method: "POST",
      body: fd
    });

    const data = await res.json();

    if (data.error)
      return alert("Upload failed: " + data.error);

    loadGallery();

  } catch (err) {
    alert("Upload failed â€” check console");
    console.error(err);
  }
}

/* ===== LIGHTBOX CORE ===== */

function show(i) {
  index = i;

  content.innerHTML = "";

  const f = media[i];
  let el;

  if (f.type === "image") {
    el = document.createElement("img");
    el.src = f.src;

  } else {
    el = document.createElement("video");

    el.src = f.src;

    el.controls = true;
    el.muted = true;       // mobile chrome rule
    el.autoplay = true;
    el.playsInline = true;
  }

  // TAP LEFT/RIGHT ON MOBILE
  if (isTouch) {
    el.addEventListener("pointerup", e => {
      e.stopPropagation();

      const mid = window.innerWidth / 2;
      navigate(e.clientX < mid ? -1 : 1);
    });
  }

  content.appendChild(el);
  lightbox.style.display = "flex";
}

function close() {
  lightbox.style.display = "none";
  content.innerHTML = "";
}

function navigate(d) {
  show((index + d + media.length) % media.length);
}

/* ===== LOAD GALLERY ===== */

async function loadGallery() {
  try {
    const res =
      await fetch(`/galleries/${username}/gallery.json`);

    const data = await res.json();

    document.body.style.background = data.bg_color;
    document.body.style.color = data.text_color;

    titleEl.textContent = data.title;

    galleryEl.innerHTML = "";

    // convert to lightbox format
    media = data.items
      .sort((a,b)=>a.batch-b.batch || a.seq-b.seq)
      .map(i => ({
        type: i.type === "video" ? "video" : "image",
        src: "media/" + i.stored
      }));

    media.forEach((f,i) => {

      let el =
        document.createElement(
          f.type === "image" ? "img" : "video"
        );

      el.src = f.src;

      if (f.type === "video") {
        el.muted = true;
        el.loop = true;
        el.autoplay = true;
        el.playsInline = true;
      }

      if (isTouch)
        el.addEventListener("pointerup", () => show(i));
      else
        el.onclick = () => show(i);

      galleryEl.appendChild(el);
    });

  } catch(err) {
    console.error(err);
    galleryEl.innerHTML =
      "<p>Unable to load gallery</p>";
  }
}

/* ===== CLOSE LIGHTBOX ===== */

lightbox.addEventListener("click", e => {
  if (!content.contains(e.target)) close();
});

/* ===== DESKTOP CONTROLS ===== */

if (!isTouch) {

  prev.onclick = e => {
    e.stopPropagation();
    navigate(-1);
  };

  next.onclick = e => {
    e.stopPropagation();
    navigate(1);
  };

  document.addEventListener("keydown", e => {

    if (lightbox.style.display !== "flex") return;

    if (e.key === "ArrowLeft") navigate(-1);
    if (e.key === "ArrowRight") navigate(1);
    if (e.key === "Escape") close();
  });
}

/* ===== MOBILE SWIPE ===== */

let startX = 0;

if (isTouch) {

  lightbox.addEventListener("touchstart", e => {
    startX = e.touches[0].clientX;
  }, { passive: true });

  lightbox.addEventListener("touchend", e => {

    const dx =
      startX - e.changedTouches[0].clientX;

    if (Math.abs(dx) > window.innerWidth * 0.12)
      navigate(dx > 0 ? 1 : -1);

  }, { passive: true });
}

/* ===== INIT ===== */
loadGallery();

</script>
</body>
</html>
