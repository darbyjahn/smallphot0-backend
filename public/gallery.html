<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gallery</title>
</head>
<body>

<h1 id="title"></h1>

<!-- BACK BUTTON -->
<button id="backBtn">Back to Main Page</button>

<!-- UPLOAD FORM -->
<div>
  <input type="file" id="files" multiple>
  <button id="uploadBtn">Upload</button>
</div>

<!-- GALLERY DISPLAY -->
<div id="gallery"></div>

<script>
const username = location.pathname.split("/")[2];

// Back button
document.getElementById("backBtn").onclick = () => {
  window.location.href = "/";
};

// Upload function
document.getElementById("uploadBtn").onclick = async () => {
  const files = document.getElementById("files").files;
  if (!files.length) return alert("Select at least one file");

  const fd = new FormData();
  for (let f of files) fd.append("files", f);

  try {
    const res = await fetch(`/api/upload/${username}`, {
      method: "POST",
      body: fd
    });
    const data = await res.json();

    if (data.error) {
      alert("Upload failed: " + data.error);
      return;
    }

    alert("Upload successful!");
    loadGallery(); // refresh gallery display
  } catch (err) {
    console.error(err);
    alert("Upload failed due to server error");
  }
};

// Load gallery items
async function loadGallery() {
  try {
    const res = await fetch("gallery.json");
    const g = await res.json();

    document.getElementById("title").textContent = g.title;
    document.body.style.background = g.bg_color || "#fff";
    document.body.style.color = g.text_color || "#000";

    const gal = document.getElementById("gallery");
    gal.innerHTML = "";

    g.items.forEach(i => {
      const el = document.createElement(i.type === "video" ? "video" : "img");
      el.src = "media/" + i.stored;
      if (i.type === "video") {
        el.controls = true;
        el.playsInline = true;
      }
      gal.appendChild(el);
    });

  } catch (err) {
    console.error("Failed to load gallery:", err);
    alert("Could not load gallery data");
  }
}

// Initial load
loadGallery();
</script>
</body>
</html>
