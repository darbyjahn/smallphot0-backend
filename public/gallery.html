<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gallery</title>
<link rel="stylesheet" href="/styles.css">

<style>
#lightbox {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

#lightbox-content img,
#lightbox-content video {
  max-width: 90vw;
  max-height: 90vh;
  border-radius: 12px;
  object-fit: contain;
}

.arrow {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  font-size: 4em;
  color: white;
  cursor: pointer;
  user-select: none;
}

#prev { left: 10px; }
#next { right: 10px; }

#deleteItemBtn {
  position: absolute;
  top: 16px;
  right: 16px;
  z-index: 3000;
  background: none;
  border: none;
  font-size: 16px;
  color: #fff;
  cursor: pointer;
  opacity: 0.85;
  transition: transform .15s ease, opacity .15s ease;
}
#deleteItemBtn:hover { transform: scale(1.2); opacity: 1; }

@media (max-width: 700px) {
  .arrow { display: none; }
}

#progressWrap {
  width: 100%;
  max-width: 420px;
  background: #eee;
  border-radius: 8px;
  margin-top: 10px;
  display: none;
}

#progressBar {
  width: 0%;
  height: 12px;
  background: #4caf50;
  border-radius: 8px;
  transition: width .2s ease;
}

#progressText {
  font-size: 12px;
  margin-top: 4px;
}

#backBtn,
#deleteBtn {
  position: fixed;
  top: 16px;
  background: none;
  border: none;
  font-size: 14px;
  font-family: Arial, Helvetica, sans-serif;
  cursor: pointer;
  transition: transform .15s ease, opacity .15s ease;
  opacity: .85;
}

#backBtn { left: 16px; }
#deleteBtn { right: 16px; }

#backBtn:hover,
#deleteBtn:hover { transform: scale(1.12); opacity: 1; }

.gallery img,
.gallery video {
  cursor: grab;
  transition: transform .15s ease;
}
.gallery img:hover,
.gallery video:hover { transform: scale(1.05); }

</style>
</head>
<body>

<button id="backBtn">ALL GALLERIES</button>
<button id="deleteBtn">DELETE GALLERY</button>

<h1 id="title"></h1>

<div class="upload">
  <input type="file" id="files" multiple name="files">
  <button onclick="upload()">Upload</button>

  <div id="progressWrap">
    <div id="progressBar"></div>
  </div>
  <div id="progressText"></div>
</div>

<div class="gallery" id="gallery"></div>

<div id="lightbox">
  <button id="deleteItemBtn">DELETE</button>
  <div id="prev" class="arrow">&#10094;</div>
  <div id="lightbox-content"></div>
  <div id="next" class="arrow">&#10095;</div>
</div>

<!-- Sortable.js -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
let username = location.pathname.split("/")[2];

const galleryEl = document.getElementById("gallery");
const titleEl = document.getElementById("title");

const lightbox = document.getElementById("lightbox");
const content = document.getElementById("lightbox-content");
const prev = document.getElementById("prev");
const next = document.getElementById("next");
const deleteItemBtn = document.getElementById("deleteItemBtn");

const progressWrap = document.getElementById("progressWrap");
const progressBar = document.getElementById("progressBar");
const progressText = document.getElementById("progressText");

let media = [];
let index = 0;
const isTouch = "ontouchstart" in window || navigator.maxTouchPoints > 0;

/* ===== NAV ===== */
document.getElementById("backBtn").onclick = () => window.location.href="/";

document.getElementById("deleteBtn").onclick = async () => {
  const ok = confirm(" !! This will permanently delete this gallery and ALL its media. Do you want to continue ?!!");
  if (!ok) return;
  try {
    const res = await fetch(`/api/delete/${username}`, { method: "DELETE" });
    const data = await res.json();
    if (data.error) return alert("Delete failed: " + data.error);
    window.location.href = "/";
  } catch (err) {
    alert("Delete failed — check console");
    console.error(err);
  }
};

/* ===== UPLOAD ===== */
function upload() {
  const files = document.getElementById("files").files;
  if (!files.length) return alert("Select files");

  const fd = new FormData();
  for (let f of files) fd.append("files", f);

  const xhr = new XMLHttpRequest();
  xhr.open("POST", `/api/upload/${username}`);

  progressWrap.style.display = "block";
  progressBar.style.width = "0%";
  progressText.textContent = "Starting upload...";

  xhr.upload.onprogress = e => {
    if (e.lengthComputable) {
      const pct = Math.round((e.loaded / e.total) * 100);
      progressBar.style.width = pct + "%";
      progressText.textContent = `Uploading: ${pct}%`;
    }
  };

  xhr.onload = () => {
    if (xhr.status !== 200) {
      progressText.textContent = "Upload failed";
      return alert("Upload failed");
    }
    progressBar.style.width = "100%";
    progressText.textContent = "Processing complete ✅";
    setTimeout(() => {
      progressWrap.style.display = "none";
      progressText.textContent = "";
    }, 1200);
    loadGallery(true);
  };

  xhr.onerror = () => {
    progressText.textContent = "TOO LARGE (probably), try one at a time with videos";
    alert("Upload failed — check console");
  };

  xhr.send(fd);
}

/* ===== LIGHTBOX ===== */
function show(i) {
  index = i;
  content.innerHTML = "";
  const f = media[i];
  let el;

  if (f.type === "image") {
    el = document.createElement("img");
    el.src = f.src;
  } else {
    el = document.createElement("video");
    el.src = f.src;
    el.controls = true;
    el.muted = true;
    el.autoplay = true;
    el.playsInline = true;
  }

  if (isTouch) {
    el.addEventListener("pointerup", e => {
      e.stopPropagation();
      const mid = window.innerWidth / 2;
      navigate(e.clientX < mid ? -1 : 1);
    });
  }

  content.appendChild(el);
  lightbox.style.display = "flex";
}

/* ===== DELETE INDIVIDUAL ITEM ===== */
deleteItemBtn.onclick = async () => {
  const f = media[index];
  if (!f) return;
  const ok = confirm("Delete this item?");
  if (!ok) return;

  try {
    const filename = f.src.replace("media/", "");
    const res = await fetch(`/api/deleteItem/${username}/${filename}`, { method: "DELETE" });
    const data = await res.json();
    if (data.error) return alert("Delete failed: " + data.error);
    lightbox.style.display = "none";
    loadGallery(false);
  } catch (err) {
    console.error(err);
    alert("Delete failed — check console");
  }
};

function close() { lightbox.style.display = "none"; content.innerHTML = ""; }
function navigate(d) { show((index + d + media.length) % media.length); }

/* ===== LOAD GALLERY ===== */
async function loadGallery(keepDOM = false) {
  try {
    const res = await fetch(`/galleries/${username}/gallery.json?nocache=` + Date.now());
    const data = await res.json();

    document.body.style.background = data.bg_color || "#ffffff";
    document.body.style.color = data.text_color || "#000000";
    titleEl.textContent = data.title || username;

    if (!keepDOM) galleryEl.innerHTML = "";

    media = data.items
      .sort((a,b)=>a.batch-b.batch || a.seq-b.seq)
      .map(i => ({ type: i.type==="video"?"video":"image", src:"media/"+i.stored }));

    galleryEl.innerHTML = "";

    media.forEach((f,i) => {
      let el = document.createElement(f.type==="image"?"img":"video");
      el.src = f.src;
      if(f.type==="video"){el.muted=true;el.loop=true;el.autoplay=true;el.playsInline=true;}
      el.onclick = () => show(i);
      galleryEl.appendChild(el);
    });

    /* ===== MAKE GALLERY DRAGGABLE ===== */
    Sortable.create(galleryEl, {
      animation: 150,
      onEnd: async evt => {
        const newOrder = Array.from(galleryEl.children).map(c => media.find(m => m.src===c.src).src);
        try {
          await fetch(`/api/reorder/${username}`, {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ order: newOrder })
          });
        } catch(e){console.error(e);}
      }
    });

  } catch(err) {
    console.error(err);
    galleryEl.innerHTML = "<p>Unable to load gallery — try refreshing</p>";
  }
}

/* ===== LIGHTBOX CLOSE & NAV ===== */
lightbox.addEventListener("click", e => { if(!content.contains(e.target)) close(); });
if(!isTouch){
  prev.onclick=e=>{e.stopPropagation();navigate(-1);};
  next.onclick=e=>{e.stopPropagation();navigate(1);};
  document.addEventListener("keydown", e=>{
    if(lightbox.style.display!=="flex")return;
    if(e.key==="ArrowLeft") navigate(-1);
    if(e.key==="ArrowRight") navigate(1);
    if(e.key==="Escape") close();
  });
}
let startX=0;
if(isTouch){
  lightbox.addEventListener("touchstart", e=>{startX=e.touches[0].clientX;},{passive:true});
  lightbox.addEventListener("touchend", e=>{
    const dx=startX-e.changedTouches[0].clientX;
    if(Math.abs(dx)>window.innerWidth*0.12) navigate(dx>0?1:-1);
  },{passive:true});
}

loadGallery();
</script>
</body>
</html>
