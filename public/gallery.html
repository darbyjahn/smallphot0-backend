<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gallery</title>
<link rel="stylesheet" href="/styles.css">
</head>
<body>

<button id="backBtn">â¬… Back to Galleries</button>

<!-- NEW DELETE BUTTON -->
<button id="deleteBtn" style="background:#c33;color:white;margin-left:8px;">
  ðŸ—‘ Delete Gallery
</button>

<h1 id="title"></h1>

<div class="upload">
  <input type="file" id="files" multiple name="files">
  <button onclick="upload()">Upload</button>
</div>

<div class="gallery" id="gallery"></div>

<script>
let username = location.pathname.split("/")[2];
const galleryEl = document.getElementById("gallery");
const titleEl = document.getElementById("title");

document.getElementById("backBtn").onclick = () => window.location.href="/";


/* =======================================================
   DELETE GALLERY
   ======================================================= */
document.getElementById("deleteBtn").onclick = async () => {

  const ok = confirm(
    "âš ï¸ This will permanently delete this gallery and ALL its media.\n\nContinue?"
  );

  if (!ok) return;

  try {
    const res = await fetch(`/api/delete/${username}`, {
      method: "DELETE"
    });

    const data = await res.json();

    if (data.error) {
      return alert("Delete failed: " + data.error);
    }

    // SUCCESS â†’ go back home
    window.location.href = "/";

  } catch (err) {
    alert("Delete failed â€” check console");
    console.error(err);
  }
};


/* =======================================================
   UPLOAD
   ======================================================= */
async function upload() {
  const files = document.getElementById("files").files;
  if (!files.length) return alert("Select files");

  const fd = new FormData();
  for (let f of files) fd.append("files", f);

  try {
    const res = await fetch(`/api/upload/${username}`, {
      method: "POST",
      body: fd
    });

    const data = await res.json();
    if (data.error) return alert("Upload failed: " + data.error);

    loadGallery(); // reload after upload

  } catch (err) {
    alert("Upload failed â€” check console");
    console.error(err);
  }
}


/* =======================================================
   LOAD GALLERY
   ======================================================= */
async function loadGallery() {
  try {
    const res = await fetch(`/galleries/${username}/gallery.json`);
    const data = await res.json();

    document.body.style.background = data.bg_color;
    document.body.style.color = data.text_color;
    titleEl.textContent = data.title;

    galleryEl.innerHTML = "";

    data.items
      .sort((a,b)=>a.batch-b.batch || a.seq-b.seq)
      .forEach(i => {

        const el = document.createElement(
          i.type === "video" ? "video" : "img"
        );

        el.src = "media/" + i.stored;

        if (i.type === "video") {
          el.controls = true;
          el.playsInline = true;
        }

        galleryEl.appendChild(el);
      });

  } catch(err) {
    console.error(err);
    galleryEl.innerHTML = "<p>Unable to load gallery</p>";
  }
}

loadGallery();
</script>

</body>
</html>
