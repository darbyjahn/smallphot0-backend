<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Gallery</title>
<link rel="stylesheet" href="/styles.css"/>

<style>
body{margin:0;font-family:Arial,Helvetica,sans-serif}

/* HEADER */
.header{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  align-items:center;
  padding:10px;
}
.header button{
  font-size:13px;
  cursor:pointer;
  transition:0.2s all;
  padding:6px 12px;
  border:none;
  border-radius:4px;
  box-shadow:0 4px #999;
  background:#eee;
}
.header button:active{
  transform:translateY(2px);
  box-shadow:0 2px #666;
}
.header button:hover{
  opacity:0.85;
}
#editModeBtn.viewMode{background:#4caf50;color:white;}
#editModeBtn.editMode{background:#f44336;color:white;}
#deleteBtn{background:#ff9800;color:white;}

.header-column{
  display:flex;
  flex-direction:column;
}

/* TITLE */
#title{text-align:center;margin:4px 0 8px 0}

/* GRID */
.gallery{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(130px,1fr));
  gap:8px;
  padding:10px;
}
.gallery img,
.gallery video{
  width:100%;
  height:100%;
  object-fit:cover;
  border-radius:6px;
  cursor:pointer;
  background:#000;
}

/* LIGHTBOX */
#lightbox{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.9);
  justify-content:center;
  align-items:center;
  z-index:2000;
}
#lightbox-content{
  position:relative;
  max-width:90vw;
  max-height:90vh;
}
#lightbox-content img,
#lightbox-content video{
  max-width:100%;
  max-height:100%;
  border-radius:8px;
  display:block;
}

.nav{
  position:absolute;
  top:50%;
  transform:translateY(-50%);
  color:white;
  font-size:32px;
  cursor:pointer;
  user-select:none;
  z-index:2100;
}
#prev{left:10px}
#next{right:10px}
@media (pointer: coarse) { .nav { display: none; } }

#deleteItemBtn{
  position:absolute;
  top:10px;
  right:10px;
  background:none;
  border:none;
  color:white;
  z-index:2200;
}

/* UPLOAD BAR */
#progressWrap{
  width:90%;
  max-width:400px;
  background:#eee;
  border-radius:8px;
  margin:6px auto;
  display:none;
}
#progressBar{
  width:0%;
  height:10px;
  background:#4caf50;
  border-radius:8px;
  transition:.2s;
}
#progressText{
  text-align:center;
  font-size:12px;
}

/* COUNTER */
#counter{
  text-align:center;
  font-size:12px;
  margin:6px 0 12px 0;
  opacity:.8;
}

/* SAVE ORDER */
#saveOrderBtn{
  display:none;
  margin:6px auto;
  padding:6px 12px;
  font-size:12px;
  cursor:pointer;
  box-shadow:0 4px #999;
  border:none;
  border-radius:4px;
  background:#2196f3;
  color:white;
}
#saveOrderBtn:active{
  transform:translateY(2px);
  box-shadow:0 2px #666;
}

.upload{display:none;}
.upload input, .upload button{margin:4px;}
</style>
</head>

<body>

<div class="header">
  <button id="backBtn">ALL GALLERIES</button>

  <div class="header-column">
    <button id="editModeBtn" class="viewMode">Edit</button>
    <button id="deleteBtn" style="display:none;">DELETE GALLERY</button>
  </div>
</div>

<h1 id="title"></h1>

<div class="upload">
  <input type="file" id="files" multiple>
  <button onclick="upload()">Upload</button>

  <div id="progressWrap"><div id="progressBar"></div></div>
  <div id="progressText"></div>
</div>

<button id="saveOrderBtn">Save Order</button>

<div class="gallery" id="gallery"></div>

<div id="counter"></div>

<div id="lightbox">
  <div id="prev" class="nav">‹</div>
  <div id="next" class="nav">›</div>

  <button id="deleteItemBtn">DELETE</button>
  <div id="lightbox-content"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
let username = location.pathname.split("/")[2];
const galleryEl = document.getElementById("gallery");
const content = document.getElementById("lightbox-content");
const lightbox = document.getElementById("lightbox");

let media=[], index=0;

/* ===== THUMBNAILS ===== */
function createThumb(f,i){
  let el=document.createElement(f.type==="image"?"img":"video");

  el.src=f.src;

  if(f.type==="video"){
    el.muted=true;
    el.loop=true;
    el.autoplay=true;
    el.playsInline=true;
    el.setAttribute("playsinline","");
    el.play && el.play().catch(()=>{});
  }

  el.onclick=()=>show(i);
  return el;
}

/* ===== LIGHTBOX ===== */
function show(i){
  index=i;
  renderLightbox();
  lightbox.style.display="flex";
}

function renderLightbox(){
  content.innerHTML="";
  const f=media[index];
  if(!f)return;

  let el=document.createElement(f.type==="image"?"img":"video");
  el.src=f.src;

  if(f.type==="video"){
    el.muted=true;
    el.loop=true;
    el.autoplay=true;
    el.playsInline=true;
    el.setAttribute("playsinline","");
    el.play().catch(()=>{});
  }

  /* --- THE IMPORTANT PART --- */
  el.addEventListener("pointerup", e=>{
    e.stopPropagation();

    const r=el.getBoundingClientRect();
    const x=e.clientX-r.left;
    const w=r.width;

    const L=w*0.25;
    const R=w*0.75;

    if(x<L) return navigate(-1);
    if(x>R) return navigate(1);

    if(f.type==="video"){
      if(el.paused){
        el.play();
        el.muted=false;
      }else{
        el.pause();
      }
    }
  });

  content.appendChild(el);
}

/* ===== NAV ===== */
function navigate(d){
  index=(index+d+media.length)%media.length;
  renderLightbox();
}

prev.onclick=e=>{e.stopPropagation();navigate(-1)};
next.onclick=e=>{e.stopPropagation();navigate(1)};

lightbox.onclick=e=>{
  if(!content.contains(e.target))
    lightbox.style.display="none";
};

/* ===== LOAD ===== */
async function loadGallery(){
  const res=await fetch(`/galleries/${username}/gallery.json?`+Date.now());
  const data=await res.json();

  media=data.items.map(i=>({
    type:i.type,
    src:"media/"+i.stored
  }));

  galleryEl.innerHTML="";
  media.forEach((f,i)=>galleryEl.appendChild(createThumb(f,i)));
}

loadGallery();
</script>
</body>
</html>
