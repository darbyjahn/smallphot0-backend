<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Small Photos</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>

<h1>GALLERIES</h1>
<button class="create-btn" id="openBtn">+ Create Gallery</button>

<div id="list"></div>

<!-- MODAL -->
<div id="modal">
  <div class="modal-box">
    <h2>Create Your Gallery</h2>
    <input id="name" placeholder="Your name" />
    <label>Background<input id="bg" type="color" value="#ff9f1c" /></label>
    <label>Text<input id="text" type="color" value="#000000" /></label>
    <button id="createBtn">Create</button>
    <button class="cancel" id="cancelBtn">Cancel</button>
  </div>
</div>

<script>
const modal = document.getElementById("modal");
const openBtn = document.getElementById("openBtn");
const cancelBtn = document.getElementById("cancelBtn");
const createBtn = document.getElementById("createBtn");
const galleryList = document.getElementById("list");

openBtn.onclick = () => modal.style.display = "flex";
cancelBtn.onclick = () => modal.style.display = "none";

async function loadGalleries() {
  try {
    const res = await fetch("/galleries.json");
    const data = await res.json();
    galleryList.innerHTML = "";
    if (!data.users || !data.users.length) {
      galleryList.innerHTML = "<p>No galleries yet.</p>";
      return;
    }

    data.users.forEach(u => {
      const card = document.createElement("div");
      card.className = "card";

      const link = document.createElement("a");
      link.href = `/galleries/${u.username}/index.html`;
      link.textContent = u.title;
      card.appendChild(link);

      const delBtn = document.createElement("button");
      delBtn.textContent = "Delete";
      delBtn.onclick = async () => {
        if (!confirm(`Delete gallery "${u.title}"?`)) return;
        const res = await fetch(`/api/delete/${u.username}`, { method: "DELETE" });
        const result = await res.json();
        if (result.success) loadGalleries();
        else alert(result.error || "Delete failed");
      };
      card.appendChild(delBtn);

      galleryList.appendChild(card);
    });
  } catch {
    galleryList.innerHTML = "<p>Unable to load galleries</p>";
  }
}
loadGalleries();

createBtn.onclick = async () => {
  const name = document.getElementById("name").value.trim();
  const bg = document.getElementById("bg").value;
  const text = document.getElementById("text").value;
  if (!name) return alert("Enter a name");

  const username = name.toLowerCase().replace(/[^a-z0-9]/g, "");
  const res = await fetch("/api/create", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, title: name, bg, text })
  });
  const data = await res.json();
  if (res.status !== 200 || data.error) return alert(data.error || "Server error");
  window.location.href = `/galleries/${username}/index.html`;
};
</script>
</body>
</html>
